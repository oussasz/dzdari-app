"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={53524:e=>{e.exports=require("@prisma/client")},67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},9962:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>b,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>v,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>u});var a=r(49303),i=r(88716),n=r(60670),o=r(71615),d=r(87070),c=r(69206),l=r(88658);async function u(e){try{if(!c.A)return d.NextResponse.json({message:"Stripe is not configured",ok:!1},{status:500});let t=await e.text(),r=(0,o.headers)().get("stripe-signature");if(!r)return new Response("Invalid signature",{status:400});let s=c.A.webhooks.constructEvent(t,r,process.env.STRIPE_WEBHOOK_SECRET);if("checkout.session.completed"===s.type){if(!s.data.object.customer_details?.email)throw Error("Missing user email");let{listingId:e,startDate:t,endDate:r,totalPrice:a,userId:i}=s.data.object.metadata||{};if(!e||!t||!r||!a||!i)throw Error("Invalid request metadata");await (0,l.createReservation)({listingId:e,startDate:new Date(t),endDate:new Date(r),totalPrice:Number(a),userId:i})}return d.NextResponse.json({result:s,ok:!0})}catch(e){return console.error(e),d.NextResponse.json({message:"Something went wrong",ok:!1},{status:500})}}let p=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/home/oussasz/Project/Dz Dari/lugario/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:m,serverHooks:v}=p,h="/api/webhooks/stripe/route";function b(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:m})}},90455:(e,t,r)=>{r.d(t,{L:()=>l});var s=r(67096),a=r.n(s),i=r(13539),n=r(53797),o=r(77234),d=r(77210),c=r(9487);let l={adapter:(0,i.N)(c.db),providers:[(0,d.Z)({clientId:process.env.GITHUB_CLIENT_ID,clientSecret:process.env.GITHUB_CLIENT_SECRET}),(0,o.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,n.Z)({name:"credentials",credentials:{email:{label:"email",type:"text"},password:{label:"password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Invalid credentials");let t=await c.db.user.findUnique({where:{email:e.email}});if(!t||!t?.password||!await a().compare(e.password,t.password))throw Error("Invalid credentials");return t}})],callbacks:{session:async({token:e,session:t})=>(e&&(t.user.id=e.id,t.user.name=e.name,t.user.email=e.email),t),jwt:async({token:e,user:t})=>t?{...e,...t}:e},pages:{signIn:"/"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},9487:(e,t,r)=>{r.d(t,{db:()=>a});var s=r(53524);let a=globalThis.prisma||new s.PrismaClient},69206:(e,t,r)=>{r.d(t,{A:()=>i});var s=r(82604);let a=process.env.STRIPE_API_KEY,i=a?new s.Z(a,{apiVersion:"2024-09-30.acacia",typescript:!0}):null},97049:(e,t,r)=>{e.exports=r(23191).vendored["react-rsc"].ReactDOM},51749:(e,t,r)=>{e.exports=r(23191).vendored["react-rsc"].ReactServerDOMWebpackServerEdge},88658:(e,t,r)=>{r.r(t),r.d(t,{$$ACTION_0:()=>u,$$ACTION_1:()=>f,$$ACTION_2:()=>v,$$ACTION_3:()=>b,createPaymentSession:()=>h,createReservation:()=>p,deleteReservation:()=>m,getReservations:()=>l});var s=r(24330);r(60166);var a=r(57708),i=r(9487),n=r(67738),o=r(84848),d=r(69206),c=r(40618);let l=(0,s.j)("31b04723e7c53cd1acbec67b730e7d0abc16a5f7",u);async function u(e){try{let{listingId:t,userId:r,authorId:s,cursor:a}=e,o={};r&&(o.userId=r),t&&(o.listingId=t),s&&(o.listing={userId:s});let d={where:o,take:n.UM,include:{listing:!0},orderBy:{createdAt:"desc"}};a&&(d.cursor={id:a},d.skip=1);let c=await i.db.reservation.findMany({...d}),l=c.length===n.UM?c[n.UM-1].id:null;return{listings:c.map(e=>{let{id:t,startDate:r,endDate:s,totalPrice:a,listing:i}=e;return{...i,reservation:{id:t,startDate:r,endDate:s,totalPrice:a}}}),nextCursor:l}}catch(e){return console.log(e?.message),{listings:[],nextCursor:null}}}let p=(0,s.j)("33f115557067f48ceee4a50b443aa423758b731d",f);async function f({listingId:e,startDate:t,endDate:r,totalPrice:s,userId:n}){try{if(!e||!t||!r||!s)throw Error("Invalid data");await i.db.listing.update({where:{id:e},data:{reservations:{create:{userId:n,startDate:t,endDate:r,totalPrice:s}}}}),(0,a.revalidatePath)(`/listings/${e}`)}catch(e){throw Error(e?.message)}}let m=(0,s.j)("3e9103be237aebf085f90f3c7858dad7d4c215ad",v);async function v(e){try{let t=await (0,o.t)();if(!t)throw Error("Unauthorized");if(!e||"string"!=typeof e)throw Error("Invalid ID");let r=await i.db.reservation.findUnique({where:{id:e}});if(!r)throw Error("Reservation not found!");return await i.db.reservation.deleteMany({where:{id:e,OR:[{userId:t.id},{listing:{userId:t.id}}]}}),(0,a.revalidatePath)("/reservations"),(0,a.revalidatePath)(`/listings/${r.listingId}`),(0,a.revalidatePath)("/trips"),r}catch(e){throw Error(e.message)}}let h=(0,s.j)("0ad09d62211ecf130a12e0b1fb6dd072ad373b1e",b);async function b({listingId:e,startDate:t,endDate:r,totalPrice:s}){if(!e||!t||!r||!s)throw Error("Invalid data");let a=await i.db.listing.findUnique({where:{id:e}});if(!a)throw Error("Listing not found!");let n=await (0,o.t)();if(!n)throw Error("Please log in to reserve!");let c=await d.A.products.create({name:"Listing",images:[a.imageSrc],default_price_data:{currency:"USD",unit_amount:100*s}});return{url:(await d.A.checkout.sessions.create({success_url:`${process.env.NEXT_PUBLIC_SERVER_URL}/trips`,cancel_url:`${process.env.NEXT_PUBLIC_SERVER_URL}/listings/${a.id}`,payment_method_types:["card"],mode:"payment",shipping_address_collection:{allowed_countries:["DE","US","NP","CH","BH","AU"]},metadata:{listingId:e,startDate:String(t),endDate:String(r),totalPrice:s,userId:n.id},line_items:[{price:c.default_price,quantity:1}]})).url}}(0,c.h)([l,p,m,h]),(0,s.j)("1106a624fc89780734d43596a1878891b0872f57",l),(0,s.j)("84b639be183e082fba4d06c9dff2f39883927b92",p),(0,s.j)("2ad9c02f7138be20aaff203fa989dbdd2c65d88f",m),(0,s.j)("578785c17f7947cb2d65472cb4242c57c8621203",h)},84848:(e,t,r)=>{r.d(t,{t:()=>i});var s=r(75571),a=r(90455);let i=async()=>{let e=await (0,s.getServerSession)(a.L);return e?.user}},67738:(e,t,r)=>{r.d(t,{KP:()=>i,UM:()=>n});var s=r(63759),a=r(43758);s.Paj,s.f$3,s.sHf,s.dKE;let i=[{id:"tourism",label:"Tourism",icon:s.Yfi,description:"Perfect for tourists and travelers"},{id:"business",label:"Business",icon:s.KfF,description:"Ideal for business travelers"},{id:"families",label:"Families",icon:s.Nzl,description:"Family-friendly accommodation"},{id:"students",label:"Students",icon:s.eAf,description:"Suitable for students"},{id:"couples",label:"Couples",icon:s.Yqy,description:"Romantic getaway for couples"},{id:"events",label:"Events",icon:s.jsv,description:"For occasions: photo shoots, engagements, birthdays..."}];s.I4E,s.rhR,s.vc9,a.Q7H,s.Ys1,s.IB_,s.bVG,s.yEz,s.XG1,s.eVG,s.WKE,s.h9I,s.fC4;let n=16}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,386,76,879,972,604],()=>r(9962));module.exports=s})();