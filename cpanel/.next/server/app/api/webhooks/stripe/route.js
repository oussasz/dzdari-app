"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={53524:e=>{e.exports=require("@prisma/client")},67096:e=>{e.exports=require("bcrypt")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},9962:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>g,requestAsyncStorage:()=>f,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var a={};t.r(a),t.d(a,{POST:()=>u});var s=t(49303),i=t(88716),n=t(60670),o=t(71615),d=t(87070),c=t(69206),l=t(88658);async function u(e){try{if(!c.A)return d.NextResponse.json({message:"Stripe is not configured",ok:!1},{status:500});let r=await e.text(),t=(0,o.headers)().get("stripe-signature");if(!t)return new Response("Invalid signature",{status:400});let a=c.A.webhooks.constructEvent(r,t,process.env.STRIPE_WEBHOOK_SECRET);if("checkout.session.completed"===a.type){if(!a.data.object.customer_details?.email)throw Error("Missing user email");let{listingId:e,startDate:r,endDate:t,totalPrice:s,userId:i}=a.data.object.metadata||{};if(!e||!r||!t||!s||!i)throw Error("Invalid request metadata");await (0,l.createReservation)({listingId:e,startDate:new Date(r),endDate:new Date(t),totalPrice:Number(s),userId:i})}return d.NextResponse.json({result:a,ok:!0})}catch(e){return console.error(e),d.NextResponse.json({message:"Something went wrong",ok:!1},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/home/oussasz/Project/Dz Dari/lugario/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:w}=p,v="/api/webhooks/stripe/route";function g(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},90455:(e,r,t)=>{t.d(r,{L:()=>c});var a=t(67096),s=t.n(a),i=t(13539),n=t(53797),o=t(77234),d=t(9487);let c={adapter:(0,i.N)(d.db),providers:[(0,o.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,n.Z)({name:"credentials",credentials:{email:{label:"email",type:"text"},password:{label:"password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Invalid credentials");let r=await d.db.user.findUnique({where:{email:e.email}});if(!r||!r?.password||!await s().compare(e.password,r.password))throw Error("Invalid credentials");return r}})],callbacks:{session:async({token:e,session:r})=>(e&&(r.user.id=e.id,r.user.name=e.name,r.user.email=e.email),r),jwt:async({token:e,user:r})=>r?{...e,...r}:e},pages:{signIn:"/"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},9487:(e,r,t)=>{t.d(r,{db:()=>s});var a=t(53524);let s=globalThis.prisma||new a.PrismaClient},69206:(e,r,t)=>{t.d(r,{A:()=>i});var a=t(82604);let s=process.env.STRIPE_API_KEY,i=s?new a.Z(s,{apiVersion:"2024-09-30.acacia",typescript:!0}):null},97049:(e,r,t)=>{e.exports=t(23191).vendored["react-rsc"].ReactDOM},51749:(e,r,t)=>{e.exports=t(23191).vendored["react-rsc"].ReactServerDOMWebpackServerEdge},88658:(e,r,t)=>{t.r(r),t.d(r,{$$ACTION_0:()=>u,$$ACTION_1:()=>f,$$ACTION_2:()=>w,$$ACTION_3:()=>g,createPaymentSession:()=>v,createReservation:()=>p,deleteReservation:()=>h,getReservations:()=>l});var a=t(24330);t(60166);var s=t(57708),i=t(9487),n=t(67738),o=t(84848),d=t(69206),c=t(40618);let l=(0,a.j)("31b04723e7c53cd1acbec67b730e7d0abc16a5f7",u);async function u(e){try{let{listingId:r,userId:t,authorId:a,cursor:s}=e,o={};t&&(o.userId=t),r&&(o.listingId=r),a&&(o.listing={userId:a});let d={where:o,take:n.UM,include:{listing:!0},orderBy:{createdAt:"desc"}};s&&(d.cursor={id:s},d.skip=1);let c=await i.db.reservation.findMany({...d}),l=c.length===n.UM?c[n.UM-1].id:null;return{listings:c.map(e=>{let{id:r,startDate:t,endDate:a,totalPrice:s,listing:i}=e;return{...i,reservation:{id:r,startDate:t,endDate:a,totalPrice:s}}}),nextCursor:l}}catch(e){return console.log(e?.message),{listings:[],nextCursor:null}}}let p=(0,a.j)("33f115557067f48ceee4a50b443aa423758b731d",f);async function f({listingId:e,startDate:r,endDate:t,totalPrice:a,userId:n}){try{if(!e||!r||!t||!a)throw Error("Invalid data");await i.db.listing.update({where:{id:e},data:{reservations:{create:{userId:n,startDate:r,endDate:t,totalPrice:a}}}}),(0,s.revalidatePath)(`/listings/${e}`)}catch(e){throw Error(e?.message)}}let h=(0,a.j)("3e9103be237aebf085f90f3c7858dad7d4c215ad",w);async function w(e){try{let r=await (0,o.t)();if(!r)throw Error("Unauthorized");if(!e||"string"!=typeof e)throw Error("Invalid ID");let t=await i.db.reservation.findUnique({where:{id:e}});if(!t)throw Error("Reservation not found!");return await i.db.reservation.deleteMany({where:{id:e,OR:[{userId:r.id},{listing:{userId:r.id}}]}}),(0,s.revalidatePath)("/reservations"),(0,s.revalidatePath)(`/listings/${t.listingId}`),(0,s.revalidatePath)("/trips"),t}catch(e){throw Error(e.message)}}let v=(0,a.j)("0ad09d62211ecf130a12e0b1fb6dd072ad373b1e",g);async function g({listingId:e,startDate:r,endDate:t,totalPrice:a}){if(!e||!r||!t||!a)throw Error("Invalid data");let s=await i.db.listing.findUnique({where:{id:e}});if(!s)throw Error("Listing not found!");let n=await (0,o.t)();if(!n)throw Error("Please log in to reserve!");let c=await d.A.products.create({name:"Listing",images:[s.imageSrc],default_price_data:{currency:"USD",unit_amount:100*a}});return{url:(await d.A.checkout.sessions.create({success_url:`${process.env.NEXT_PUBLIC_SERVER_URL}/trips`,cancel_url:`${process.env.NEXT_PUBLIC_SERVER_URL}/listings/${s.id}`,payment_method_types:["card"],mode:"payment",shipping_address_collection:{allowed_countries:["DE","US","NP","CH","BH","AU"]},metadata:{listingId:e,startDate:String(r),endDate:String(t),totalPrice:a,userId:n.id},line_items:[{price:c.default_price,quantity:1}]})).url}}(0,c.h)([l,p,h,v]),(0,a.j)("1106a624fc89780734d43596a1878891b0872f57",l),(0,a.j)("84b639be183e082fba4d06c9dff2f39883927b92",p),(0,a.j)("2ad9c02f7138be20aaff203fa989dbdd2c65d88f",h),(0,a.j)("578785c17f7947cb2d65472cb4242c57c8621203",v)},84848:(e,r,t)=>{t.d(r,{t:()=>i});var a=t(75571),s=t(90455);let i=async()=>{let e=await (0,a.getServerSession)(s.L);return e?.user}},67738:(e,r,t)=>{t.d(r,{UM:()=>i});var a=t(63759),s=t(43758);a.Paj,a.f$3,a.sHf,a.sHf,a.dKE,a.dKE,a.Yfi,a.KfF,a.Nzl,a.eAf,a.Yqy,a.jsv,a.I4E,a.rhR,a.vc9,s.Q7H,a.Ys1,a.IB_,a.bVG,a.yEz,a.XG1,a.eVG,a.WKE,a.h9I,a.fC4;let i=16}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[948,83,76,879,972,604],()=>t(9962));module.exports=a})();